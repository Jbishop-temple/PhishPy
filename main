from google_auth_oauthlib.flow import InstalledAppFlow
from pathlib import Path
import requests
from rich.console import Console
from rich.table import Table
from rich.prompt import Prompt
from rich import print
from time import sleep
#email_address = input("Whats your email?")
#search_type = input("Search from subject or from sender: ")

running = True
def AI_Phishing_Calculation(body, sender, header):
        
    API_KEY = "sk-cf23a9c220924bea8df33d8322f85595"  
    EMAIL_TEXT = body
    email_sender = str(sender)
    email_header = str(header)

    response = requests.post(
        "https://api.deepseek.com/v1/chat/completions",
        headers={
            "Authorization": "Bearer " + API_KEY,
            "Content-Type": "application/json"
        },
        json={
            "model": "deepseek-chat", 
            "messages": [
                {
                    "role": "system",
                    "content": "You are a highly specialized and accurate AI security analyst whose sole function is to detect phishing emails"
                },
                {
                    "role": "user",
                    "content": (
                        "Determine whether the following email is a phishing email. Be careful not to flag generic advertisement or billing/payments as Scam. Be Careful with Ads/advertisements they are not phishing. Striuclty follow this output 'true/false whehther email is a phishing email. true output looks like True, email is a phishing email because xyz. False output looks like False, email is not a phishing email because of x,y,z  "
                        "and explain why in 1 sentence:\n\n"
                        "Email Body: " + EMAIL_TEXT + "\n\n"
                        "Sender: " + email_sender + "\n\n"
                        "Headers: " + email_header
                    )
                }
            ]
        }
    )
    output = response.json()
    llm_response = output['choices'][0]['message']['content']
    print("\n")
    console.print(f"{llm_response[0:6]}[bold green]{llm_response[6::]}[/bold green]")
def AI_Phishing_Calculation2(body):
        
    API_KEY = "sk-cf23a9c220924bea8df33d8322f85595"  
    EMAIL_TEXT = body
    phishing_results = []
    delete_list = []


    counter = 0
    
    for text in EMAIL_TEXT:
        response = requests.post(
            "https://api.deepseek.com/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {API_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": "deepseek-chat", 
                "messages": [
                    {
                    "role": "user",
                    "content": (
                        "Determine whether the following email is a phishing email. Be careful not to flag generic advertisement or billing/payments as Scam. Be Careful with Ads/advertisements they are not phishing. Striuclty follow this output 'true/false whehther email is a phishing email. true output looks like True, email is a phishing email because xyz. False output looks like False, email is not a phishing email because of x,y,z  "
                        "and explain why in 1 sentence:\n\n"
                        "Email Body: " + text + "\n\n"
                        )
                    }
                ]
            }
        )

        output = response.json()    
        llm_response = output['choices'][0]['message']['content']
        if llm_response[0:4] == "True":
           phishing_results.append(llm_response + "\n\n")
        else:
            continue
        counter += 1
    return(phishing_results)
 
def delete_email(email_uid):
    mailbox.delete(email_uid)
    mailbox.expunge


imap_address = "https://www.googleapis.com/auth/userinfo.email https://mail.google.com/"

client_secret = r"C:\Users\Jay\Documents\Python Projects\PhishPy\Files\client_secret.json"

flow = InstalledAppFlow.from_client_secrets_file(
    client_secret,
    scopes=['openid',
    'https://www.googleapis.com/auth/userinfo.email',
    'https://mail.google.com/']
)
creds = flow.run_local_server(port=55555)
Oauth_refresh_token = (creds.token)

from imap_tools import MailBox, AND, A
while running == True:
    console = Console()
    Run_Program = Prompt.ask("[bold green]Would you like run PhishPY:[/bold green]", choices=["y", "n"], case_sensitive=False)
    if Run_Program == 'n':
        break
    elif Run_Program == 'y':
        option_choice = Prompt.ask("[bold green]Press[/bold green] [magenta](1)[/magenta] [bold green]to activate single scan or Press[/bold green] [magenta](2)[/magenta] [bold green]to activate Bulk Scan?:[/bold green]", choices=["1", "2"], case_sensitive=False)
        if option_choice == '1':
            Email_Found = False
            user_search = Prompt.ask("[green]Search:[/green] ")
            with MailBox('imap.gmail.com').xoauth2('jahzeelbishop03@gmail.com', Oauth_refresh_token, 'INBOX') as mailbox:
                search_count = 0
                email_uid = []
                console.print("[bold green]Searching...[/bold green]")
                for msg in mailbox.fetch(AND(subject=user_search)):
                    Email_Found = True
                    search_results = Table(title="[bold][yellow]Scan Results[/bold][/yellow]", border_style="green", header_style="magenta")
                    search_results.add_column("Subject", style="bold grey70")
                    search_results.add_column("From", style="bold grey70")
                    search_results.add_column("Date", style="bold grey70")
                    search_results.add_row(msg.subject, msg. from_, str(msg.date))
                    console.print(search_results)  
                    confirm = Prompt.ask("[bold green]Is this the correct email?[/bold green]", choices=["y", "n"], case_sensitive=False)
                    if confirm == 'y':
                        body = msg.text
                        sender = msg.from_
                        header = msg.headers
                        with console.status("[bold green]Determining whether Phishing Email[/bold green]", spinner="dots"):
                            sleep(3)
                            AI_Phishing_Calculation(body, sender, header)
                        delete = Prompt.ask("[bold green]Would you like to delete email?[bold green]", choices=["y", "n"], case_sensitive=False)
                        if delete == 'n':
                            continue      
                        if delete == 'y':
                            email_uid.append(msg.uid)
                            delete_email(email_uid)
                            console.print("[bold red] Deleted [/bold red]")
                            break
                    elif search_count == 5:
                        search_again = Prompt.ask("Would you like to search again?", choices=["y", "n"], case_sensitive=False)
                        if search_again == 'n':
                            continue
                        if search_again == 'y':
                            break  
                        
                    elif confirm == 'n':
                        print("[bold magenta]Skipping this email[bold magenta]")
                        search_count += 1
                        continue
                if Email_Found == False:
                    print("[red]Search Not Found[/red]")
                    search_again = Prompt.ask("Would you like to search again?", choices=["y", "n"], case_sensitive=False)
                    if search_again == 'n':
                        break  
                    if search_again == 'y':
                        continue      
        elif option_choice == '2':
            counter = 0
            with MailBox('imap.gmail.com').xoauth2('jahzeelbishop03@gmail.com', Oauth_refresh_token, 'INBOX') as mailbox:
                email_text_list = {}
                email_uid = []
                msg_data = []
                from_data = []
                date_data = []
                search_results = Table(title="[bold][yellow]Scan Results[/bold][/yellow]", border_style="green", header_style="magenta")
                search_results.add_column("Subject", style="bold grey70")
                search_results.add_column("From", style="bold grey70")
                search_results.add_column("Date", style="bold grey70")
                search_results.add_column("Phishing", style="bold grey70")
                search_results.add_column("Number", style="bold grey70")
                for msg in mailbox.fetch(reverse=True, limit=10):
                    Email_Found = True
                    msg_data.append(msg.subject)
                    from_data.append(msg.from_)
                    date_data.append(str(msg.date))
                    email_text_list[msg.subject] = (msg.text)
                    email_uid.append(msg.uid) 
                    counter += 1
                subject_list = list(email_text_list.keys())
                email_text_list = list(email_text_list.values())
                with console.status("[bold green]Analyzing Emails[/bold green]", spinner="dots"):
                    sleep(3)
                    results = AI_Phishing_Calculation2(email_text_list)
                if len(results) == 0:
                    console.print("[bold red] No Phishing Emails Found [/bold red]")
                else:
                    for message in range(len(results)):
                        search_results.add_row(msg_data[message], from_data[message], date_data[message], results[message], str(message))
                    console.print(search_results) 
                    delete = Prompt.ask("Would you like to delete any emails: y/n", choices=["y", "n"], case_sensitive=False)
                    if delete == 'n':
                        continue
                    elif delete == 'y':
                            selection = Prompt.ask("which email 1-10", choices=["1", "2", "3", "4", "5", "6 ", "7", "8", "9", "10", "all"], case_sensitive=False)
                            for i in range(len(email_uid)):
                                if selection == "i":
                                    delete_email(email_uid[i])
                                    console.print("[bold red] Deleted [/bold red]")
                                elif  selection == "all":
                                    for em in range(0,10):
                                        try:
                                            delete_email(email_uid[em])
                                        except:
                                            continue
                            console.print("[bold red] Deleted All[/bold red]")




